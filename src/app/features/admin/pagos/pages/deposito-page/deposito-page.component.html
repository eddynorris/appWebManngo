<!-- Page Header -->
<div class="page-header">
  <div class="header-content">
    <h1>
      <fa-icon [icon]="icons.cashRegister"></fa-icon>
      Gestión de Depósitos
    </h1>
    <p>Administra y registra los depósitos de pagos pendientes</p>
  </div>
  
</div>

<!-- Filtros de Búsqueda -->
<div class="filters-container">
  <h3 class="filters-title">
    <fa-icon [icon]="icons.filter"></fa-icon>
    Filtros de Búsqueda
  </h3>
  
  <form [formGroup]="filtersForm" (ngSubmit)="aplicarFiltros(filtersForm.value)">
    <div class="filters-grid">
      <div class="filter-group">
        <label for="fecha_inicio">Fecha Inicio</label>
        <input 
          type="date" 
          id="fecha_inicio"
          formControlName="fecha_inicio">
      </div>

      <div class="filter-group">
        <label for="fecha_fin">Fecha Fin</label>
        <input 
          type="date" 
          id="fecha_fin"
          formControlName="fecha_fin">
      </div>

      <div class="filter-group">
        <label for="cliente">Cliente</label>
        <select 
          id="cliente"
          formControlName="cliente">
          <option value="">Todos los clientes</option>
          @for (usuario of usuarios(); track usuario.id) {
            <option [value]="usuario.username">{{ usuario.username }}</option>
          }
        </select>
      </div>

      <div class="filter-group">
        <label for="metodo_pago">Método de Pago</label>
        <select 
          id="metodo_pago"
          formControlName="metodo_pago">
          <option value="">Todos los métodos</option>
          <option value="efectivo">Efectivo</option>
          <option value="transferencia">Transferencia</option>
          <option value="tarjeta">Tarjeta</option>
        </select>
      </div>

      <div class="filter-group">
        <div class="filter-actions">
          <button type="submit" class="btn-primary">
            <fa-icon [icon]="icons.search"></fa-icon>
            Buscar
          </button>
          <button type="button" class="btn-ghost" (click)="limpiarFiltros()">
            <fa-icon [icon]="icons.times"></fa-icon>
            Limpiar
          </button>
        </div>
      </div>
    </div>
  </form>
</div>

<!-- Acciones de selección -->
<div class="selection-actions">
  <div class="selection-controls">
    <button 
      type="button" 
      class="btn-secondary btn-sm"
      (click)="seleccionarTodos()"
      [disabled]="isLoading() || pagosPendientes().length === 0">
      <fa-icon [icon]="icons.check"></fa-icon>
      Seleccionar Todos
    </button>
    
    <button 
      type="button" 
      class="btn-secondary btn-sm"
      (click)="deseleccionarTodos()"
      [disabled]="!hayPagosSeleccionados()">
      <fa-icon [icon]="icons.times"></fa-icon>
      Deseleccionar Todos
    </button>
  </div>

  <div class="selection-summary">
    @if (hayPagosSeleccionados()) {
      <div class="summary-info">
        <span class="selected-count">{{ pagosSeleccionados().size }} pagos seleccionados</span>
        <span class="selected-total">Total: {{ formatCurrency(totalSeleccionado()) }}</span>
      </div>
    }
  </div>
</div>

<!-- Reusable Data Table -->
<div class="table-container">
  
  <app-data-table
    [data]="pagosPendientes()"
    [columns]="pagosColumns"
  >
  <ng-template #customCell let-item="$implicit" let-column="column">
    @if (column.key === 'selected') {
      <input 
        type="checkbox" 
        [checked]="isPagoSeleccionado(item.id)"
        (change)="togglePagoSeleccion(item.id)"
        class="form-check-input"
      >
    } @else if (column.key === 'monto_depositado') {
      <input 
        type="number" 
        [value]="getMontoDepositado(item.id)"
        (input)="actualizarMontoDepositado(item.id, $event)"
        class="form-control form-control-sm"
        placeholder="0.00"
        step="0.01"
        min="0"
        [disabled]="!isPagoSeleccionado(item.id)"
      >
    }
  </ng-template>
</app-data-table>
</div>

<!-- Pagination -->
@if (pagination()) {
  <app-pagination
    [pagination]="pagination()!"
    (pageChange)="onPageChange($event)"
    (perPageChange)="onPerPageChange($event)"
  ></app-pagination>
}

<!-- Botón de Acción Principal -->
<div class="main-action">
  <button 
    type="button"
    class="btn-primary btn-lg"
    [disabled]="!hayPagosSeleccionados() || isLoading()"
    (click)="abrirModalDeposito()">
    <fa-icon [icon]="icons.cashRegister"></fa-icon>
    Registrar Depósito
    @if (hayPagosSeleccionados()) {
      <span class="action-summary">({{ formatCurrency(totalSeleccionado()) }})</span>
    }
  </button>
</div>

<!-- Modal para registrar depósito -->
@if (isModalVisible()) {
  <div class="modal-overlay" (click)="cerrarModal()">
    <!-- Spinner específico para el modal -->
    @if (isSubmitting()) {
      <app-spinner 
        [forceShow]="true"
        [isGlobal]="true"
        [size]="60"
        [message]="'Procesando depósito...'"
      ></app-spinner>
    }
    
    <div class="modal-content" style="width: 90%; max-width: 800px;" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 id="depositoModalLabel">
          <fa-icon [icon]="icons.plus"></fa-icon>
          Registrar Depósito
        </h2>
        <button type="button" class="close-btn" (click)="cerrarModal()" aria-label="Close">
          <fa-icon [icon]="icons.times"></fa-icon>
        </button>
      </div>
      <div class="modal-body">

        <form [formGroup]="depositoForm" (ngSubmit)="confirmarDeposito()" class="form-section">
          <div class="form-grid two-cols">
            <div class="input-group">
              <label for="fecha_deposito">Fecha *</label>
              <input 
                type="date" 
                id="fecha_deposito"
                formControlName="fecha_deposito"
                required>
            </div>
            
            <div class="input-group">
              <label for="referencia_bancaria">Referencia Bancaria</label>
              <input 
                type="text" 
                id="referencia_bancaria"
                formControlName="referencia_bancaria"
                placeholder="Número de operación o referencia">
            </div>
          </div>
          
          <div class="form-grid one-col">
            <div class="input-group">
              <label for="comprobante">Comprobante de Depósito</label>
              <input 
                type="file" 
                id="comprobante"
                accept="image/jpeg,image/png,application/pdf"
                (change)="onFileSelected($event)"
                class="form-control-file">
              <small class="form-text text-muted">
                <fa-icon [icon]="icons.upload"></fa-icon>
                Formatos permitidos: JPG, PNG, PDF (máx. 5MB)
              </small>
            </div>
          </div>
          
          <!-- Resumen y detalle de pagos seleccionados -->
          <div class="selected-payments-section">
            <div class="selected-payments-summary">
              <h4>Pagos Seleccionados para Depósito</h4>
              <div class="summary-info">
                <span class="selected-count">{{ pagosSeleccionados().size }} pagos seleccionados</span>
                <span class="selected-total">Total: {{ formatCurrency(totalSeleccionado()) }}</span>
              </div>
            </div>

            <!-- Lista detallada de pagos seleccionados -->
            <div class="selected-payments-detail">
              <div class="payments-list">
                @for (pago of pagosSeleccionadosDetalle(); track pago.id) {
                  <div class="payment-item">
                    <div class="payment-info">
                      <div class="payment-main">
                        <span class="payment-date">{{ pago.fecha | date:'dd/MM/yyyy' }}</span>
                        <span class="payment-client">{{ pago.venta.cliente.nombre || 'Cliente no disponible' }}</span>
                      </div>
                      <span class="payment-method">{{ pago.metodo_pago }}</span>
                    </div>
                    <div class="payment-amounts">
                      <span class="original-amount">Original: {{ formatCurrency(pago.monto) }}</span>
                      <span class="deposited-amount">Depositado: {{ formatCurrency(pago.montoDepositado) }}</span>
                    </div>
                  </div>
                } @empty {
                  <div class="no-payments">
                    <p>No hay pagos seleccionados</p>
                  </div>
                }
              </div>
            </div>
          </div>
          
          <div class="form-actions">
            <button type="button" class="btn-ghost" (click)="cerrarModal()">
              <fa-icon [icon]="icons.times"></fa-icon>
              Cancelar
            </button>
            <button 
              type="submit" 
              class="btn-primary"
              [disabled]="depositoForm.invalid || isSubmitting()">
              <fa-icon [icon]="icons.save"></fa-icon>
              @if (isSubmitting()) {
                <span class="spinner-small"></span>
              }
              Registrar Depósito
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
}
