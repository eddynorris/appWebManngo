<!-- Modal Overlay -->
@if (visible) {
<div class="modal-overlay" (click)="onOverlayClick()">
  <div class="modal-container" (click)="onContentClick($event)">

    <!-- Modal Header -->
    <div class="modal-header">
      <h2>Detalle de Proyección</h2>
      <button class="close-btn" (click)="closeModal()" aria-label="Cerrar">
        <fa-icon [icon]="faTimes"></fa-icon>
      </button>
    </div>

    <!-- Modal Body with Scroll -->
    <div class="modal-body-scroll">
      @if (isLoading) {
      <div class="loading-state">
        <div class="spinner"></div>
        <p>Cargando detalle...</p>
      </div>
      } @else if (proyeccionDetalle) {

      <!-- Proyección de Compra -->
      <div class="form-section-card">
        <h3 class="section-title">
          <fa-icon [icon]="faCalendarAlt"></fa-icon>
          Proyección de Compra
        </h3>

        <div class="form-grid two-cols">
          <div class="metric-card">
            <div class="metric-header">
              <div class="metric-icon">
                <fa-icon [icon]="faCalendarAlt"></fa-icon>
              </div>
              <div class="metric-value">
                {{ formatDate(proyeccionDetalle.proyeccion_detallada.fecha_estimada) }}
              </div>
            </div>
            <div class="metric-title">Fecha Estimada</div>
          </div>

          <div class="metric-card">
            <div class="metric-header">
              <div class="metric-icon">
                <fa-icon [icon]="faDollarSign"></fa-icon>
              </div>
              <div class="metric-value">
                {{ formatCurrency(proyeccionDetalle.proyeccion_detallada.valor_estimado) }}
              </div>
            </div>
            <div class="metric-title">Valor Estimado</div>
          </div>
        </div>

        @if (proyeccionDetalle.proyeccion_detallada.productos_probables &&
        proyeccionDetalle.proyeccion_detallada.productos_probables.length > 0) {
        <div class="productos-section">
          <label class="form-label">Productos Probables:</label>
          <div class="tags-container">
            @for (producto of proyeccionDetalle.proyeccion_detallada.productos_probables; track producto) {
            <span class="status-badge partial">{{ getProductoLabel(producto) }}</span>
            }
          </div>
        </div>
        }
      </div>

      <!-- Estadísticas del Cliente -->
      <div class="form-section-card">
        <h3 class="section-title">
          <fa-icon [icon]="faChartLine"></fa-icon>
          Estadísticas del Cliente
        </h3>

        <div class="form-grid four-cols">
          <div class="metric-card">
            <div class="metric-header">
              <div class="metric-value">{{ proyeccionDetalle.estadisticas.total_ventas }}</div>
            </div>
            <div class="metric-title">Total de Ventas</div>
          </div>

          <div class="metric-card">
            <div class="metric-header">
              <div class="metric-value">{{ formatCurrency(proyeccionDetalle.estadisticas.monto_total_comprado) }}</div>
            </div>
            <div class="metric-title">Monto Total</div>
          </div>

          <div class="metric-card">
            <div class="metric-header">
              <div class="metric-value">{{ formatCurrency(proyeccionDetalle.estadisticas.promedio_compra) }}</div>
            </div>
            <div class="metric-title">Promedio / Compra</div>
          </div>

          <div class="metric-card">
            <div class="metric-header">
              <div class="metric-value">{{ proyeccionDetalle.estadisticas.frecuencia_compra_dias }}</div>
            </div>
            <div class="metric-title">Días entre Compras</div>
          </div>
        </div>

        @if (proyeccionDetalle.estadisticas.productos_mas_comprados &&
        proyeccionDetalle.estadisticas.productos_mas_comprados.length > 0) {
        <div class="productos-mas-comprados">
          <h4 class="subsection-title">Productos Más Comprados</h4>
          <div class="list-group">
            @for (producto of proyeccionDetalle.estadisticas.productos_mas_comprados; track producto.presentacion) {
            <div class="list-item">
              <span class="item-name">{{ producto.presentacion }}</span>
              <span class="item-meta">
                <fa-icon [icon]="faShoppingCart"></fa-icon>
                {{ producto.veces_comprado }} veces ({{ producto.cantidad_total }} unids.)
              </span>
            </div>
            }
          </div>
        </div>
        }
      </div>

      <!-- Historial de Ventas -->
      <div class="form-section-card">
        <h3 class="section-title">Historial de Ventas</h3>
        @if (proyeccionDetalle.historial_ventas && proyeccionDetalle.historial_ventas.length > 0) {
        <div class="table-container">
          <app-data-table [data]="proyeccionDetalle.historial_ventas" [columns]="ventasColumns"
            [isLoading]="false"></app-data-table>
        </div>
        } @else {
        <div class="empty-state">
          <p>No hay ventas registradas</p>
        </div>
        }
      </div>

      } @else {
      <div class="empty-state">
        <p>No se pudo cargar el detalle de la proyección</p>
      </div>
      }
    </div>

    <!-- Modal Footer -->
    <div class="modal-footer">
      <button class="btn-secondary" (click)="closeModal()">
        Cerrar
      </button>
    </div>
  </div>
</div>
}